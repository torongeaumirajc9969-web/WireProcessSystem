<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>漆包线生产工艺管理系统 V7.0 完美形态</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body { background-color: #f4f6f9; font-size: 0.85rem; }
        .card { box-shadow: 0 1px 3px rgba(0,0,0,0.05); border: none; margin-bottom: 15px; }
        .card-header { font-weight: bold; padding: 0.5rem 1rem; font-size: 0.95rem; }
        .card-body { padding: 0.8rem; }

        .input-group-text { padding-left: 0.3rem; padding-right: 0.3rem; background-color: #e9ecef; font-weight: bold; color: #555; font-size: 0.8rem; }
        .form-control { font-size: 0.85rem; height: calc(1.5em + 0.5rem + 2px); padding: 0.25rem 0.5rem; }

        .table td, .table th { vertical-align: middle; padding: 0.4rem; }
        .section-title { border-left: 3px solid #007bff; padding-left: 8px; margin-bottom: 10px; color: #333; font-weight: bold; font-size: 0.9rem; }

        input[type=number] { -moz-appearance: textfield; }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { opacity: 1; height: auto; }

        .side-badge { display: inline-block; width: 20px; text-align: center; border-radius: 3px; color: #fff; font-size: 0.75rem; margin-right: 5px; }
        .badge-a { background-color: #007bff; }
        .badge-b { background-color: #ff9800; }
        .badge-round { background-color: #17a2b8; } /* 圆线专用颜色 */

        .d-none-custom { display: none !important; }

        .input-tolerance { max-width: 60px; text-align: center; border-left: 0; }
        .input-group-text-middle { border-left: 0; border-right: 0; background: white; font-weight: normal; color: #888; }

        .manual-control-group { background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; padding: 3px 8px; margin-top: 4px; display: flex; align-items: center; justify-content: space-between; }
        .manual-label { font-size: 0.75rem; color: #856404; font-weight: bold; margin-right: 5px; }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-3 py-2">
        <div class="container-fluid">
            <div>
                <span class="navbar-brand mb-0 h1" style="font-size: 1.1rem;"><i class="fas fa-industry mr-2"></i>漆包线生产工艺模型</span>
            </div>

            {% if current_user.is_authenticated %}
            <div class="d-flex align-items-center">
                <span class="text-white mr-3 small">
                    <i class="fas fa-user-circle"></i> {{ current_user.username }}
                    {% if current_user.role == 'admin' %}(管理员){% endif %}
                </span>
                <a href="/analysis" class="btn btn-outline-info btn-sm mr-2 py-0" style="font-size: 0.8rem;">
                    <i class="fas fa-chart-line"></i> 分析
                </a>
                <a href="/logout" class="btn btn-danger btn-sm py-0" style="font-size: 0.8rem;">
                    <i class="fas fa-sign-out-alt"></i> 退出
                </a>
            </div>
            {% endif %}
        </div>
    </nav>

    <div class="container-fluid px-3">

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="alert alert-{{ category }} alert-dismissible fade show py-2 small">
                  {{ message }}
                  <button type="button" class="close py-2" data-dismiss="alert">&times;</button>
              </div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <div class="card">
            <div class="card-header bg-primary text-white py-2 d-flex justify-content-between align-items-center">
                <span><i class="fas fa-edit"></i> 工艺记录单</span>
                <button type="button" class="btn btn-sm btn-light text-primary font-weight-bold py-0" onclick="clearForm()">
                    <i class="fas fa-eraser"></i> 清空重置
                </button>
            </div>
            <div class="card-body">
                <form action="/" method="POST" id="recordForm" onsubmit="return prepareSubmission()">

                    <div class="form-row align-items-center mb-2">
                        <div class="col-md-12">
                            <div class="section-title mb-0">基础生产信息</div>
                        </div>
                    </div>

                    <div class="form-row mb-3">
                        <div class="col-md-3 mb-1">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend"><span class="input-group-text">机台</span></div>
                                <div class="input-group-prepend"><span class="input-group-text bg-white">L</span></div>
                                <select class="form-control" name="machine_type" id="machineTypeSelect" required>
                                    <option value="" disabled selected>-</option>
                                    {% for i in range(1, 8) %}
                                    <option value="{{ i }}" {% if last_data and last_data.machine_type == i|string %}selected{% endif %}>{{ i }}</option>
                                    {% endfor %}
                                </select>
                                <div class="input-group-prepend"><span class="input-group-text">-</span></div>
                                <select class="form-control" name="machine_num" id="machineNumSelect" required>
                                    </select>
                                <input type="hidden" id="lastMachineNum" value="{{ last_data.machine_num if last_data else '' }}">
                            </div>
                        </div>

                        <div class="col-md-3 mb-1">
                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend"><span class="input-group-text">型号</span></div>
                                <select class="form-control" id="productTypeSelect" onchange="handleProductChange()">
                                    <option value="" disabled selected>请选择</option>
                                    <option value="QZB-2/130">QZB-2/130</option>
                                    <option value="Q(ZY/XY)-2/220">Q(ZY/XY)-2/220</option>
                                    <option value="QZYB-2/180">QZYB-2/180</option>
                                    <option value="Q(ZY/XY)LB-2/200">Q(ZY/XY)LB-2/200</option>
                                    <option value="BYQQNB-2/120">BYQQNB-2/120</option>
                                    <option value="BYQZB-2/130">BYQZB-2/130</option>
                                    <option value="OTHER">其他...</option>
                                </select>
                                <input type="text" class="form-control d-none-custom" name="product_type" id="productTypeInput" placeholder="输入型号" required value="{{ last_data.product_type if last_data else '' }}">
                            </div>

                            <div id="manualControlGroup" class="d-none-custom manual-control-group">
                                <div>
                                    <span class="manual-label">形状:</span>
                                    <div class="custom-control custom-radio custom-control-inline mr-2">
                                        <input type="radio" id="shapeFlat" name="customShape" class="custom-control-input" value="flat" checked onchange="toggleSpecInput()">
                                        <label class="custom-control-label" for="shapeFlat" style="font-size: 0.8rem;">扁线</label>
                                    </div>
                                    <div class="custom-control custom-radio custom-control-inline mr-0">
                                        <input type="radio" id="shapeRound" name="customShape" class="custom-control-input" value="round" onchange="toggleSpecInput()">
                                        <label class="custom-control-label" for="shapeRound" style="font-size: 0.8rem;">圆线</label>
                                    </div>
                                </div>
                                <div class="border-left pl-2 ml-1">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" class="custom-control-input" id="manualSBCheck" onchange="syncSBState()">
                                        <label class="custom-control-label font-weight-bold text-danger" for="manualSBCheck" style="font-size: 0.8rem;">自粘</label>
                                    </div>
                                </div>
                            </div>

                            <div class="d-none-custom">
                                <input type="checkbox" name="is_self_bonding" id="realSBSwitch">
                            </div>
                        </div>

                        <div class="col-md-3 mb-1">
                            <input type="hidden" name="wire_spec" id="finalWireSpec" value="{{ last_data.wire_spec if last_data else '' }}">

                            <div class="input-group input-group-sm" id="specFlatGroup">
                                <div class="input-group-prepend"><span class="input-group-text">规格</span></div>
                                <input type="number" step="0.01" class="form-control text-center px-1" id="specA" placeholder="a">
                                <div class="input-group-prepend input-group-append"><span class="input-group-text bg-white border-left-0 border-right-0">×</span></div>
                                <input type="number" step="0.01" class="form-control text-center px-1" id="specB" placeholder="b">
                            </div>

                            <div class="input-group input-group-sm d-none-custom" id="specRoundGroup">
                                <div class="input-group-prepend"><span class="input-group-text">线径 Φ</span></div>
                                <input type="number" step="0.001" class="form-control" id="specDiameter" placeholder="mm">
                            </div>
                        </div>

                        <div class="col-md-3 mb-1">
                            <input type="hidden" name="ref_speed" id="finalSpeedStr" value="{{ last_data.ref_speed if last_data else '' }}">

                            <div class="input-group input-group-sm">
                                <div class="input-group-prepend"><span class="input-group-text">速度</span></div>
                                <input type="number" step="0.1" class="form-control" id="speedBase" placeholder="基准">
                                <div class="input-group-prepend input-group-append"><span class="input-group-text input-group-text-middle">±</span></div>
                                <input type="number" step="0.1" class="form-control input-tolerance" id="speedTol" value="0.5">
                            </div>
                        </div>
                    </div>

                    <div class="section-title">漆包工艺设定</div>
                    <div class="row no-gutters mb-3">
                        <div class="col-md-4 pr-1">
                            <div class="paint-row d-flex align-items-center">
                                <span class="mr-2 font-weight-bold small text-muted" style="min-width: 40px;">底漆</span>
                                <div class="input-group input-group-sm">
                                    <select class="form-control" name="base_coat_type" id="baseCoatSelect">
                                        <option value="无">无</option>
                                        <option value="1731">1731</option><option value="1748">1748</option><option value="1766">1766</option><option value="225">225</option><option value="31/35">31/35</option><option value="JQ">JQ</option><option value="自粘">自粘</option>
                                    </select>
                                    <input type="number" min="0" step="1" class="form-control" name="base_coat_pass" placeholder="道次" style="max-width: 60px;" value="{{ last_data.base_coat_pass if last_data else '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 px-1">
                            <div class="paint-row d-flex align-items-center">
                                <span class="mr-2 font-weight-bold small text-muted" style="min-width: 40px;">中漆</span>
                                <div class="input-group input-group-sm">
                                    <select class="form-control" name="mid_coat_type" id="midCoatSelect">
                                        <option value="无">无</option>
                                        <option value="1731">1731</option><option value="1748">1748</option><option value="1766">1766</option><option value="225">225</option><option value="31/35">31/35</option><option value="JQ">JQ</option><option value="自粘">自粘</option>
                                    </select>
                                    <input type="number" min="0" step="1" class="form-control" name="mid_coat_pass" placeholder="道次" style="max-width: 60px;" value="{{ last_data.mid_coat_pass if last_data else '' }}">
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 pl-1">
                            <div class="paint-row d-flex align-items-center">
                                <span class="mr-2 font-weight-bold small text-muted" style="min-width: 40px;">面漆</span>
                                <div class="input-group input-group-sm">
                                    <select class="form-control" name="top_coat_type" id="topCoatSelect">
                                        <option value="无">无</option>
                                        <option value="1731">1731</option><option value="1748">1748</option><option value="1766">1766</option><option value="225">225</option><option value="31/35">31/35</option><option value="JQ">JQ</option><option value="自粘">自粘</option>
                                    </select>
                                    <input type="number" min="0" step="1" class="form-control" name="top_coat_pass" placeholder="道次" style="max-width: 60px;" value="{{ last_data.top_coat_pass if last_data else '' }}">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="section-title">标准参数 (单位: mm)</div>
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <div class="card h-100 border-secondary">
                                <div class="card-header py-1 text-center bg-light small" id="titleBare">半成品裸径</div>
                                <div class="card-body px-2 py-2">
                                    <div class="input-group input-group-sm mb-2" id="rowBareA">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-a badge-dynamic-a">A</span></div>
                                        <input type="number" step="0.01" class="form-control text-center" name="tol_a_bare_min" placeholder="min" value="{{ last_data.tol_a_bare_min if last_data else '' }}">
                                        <div class="input-group-prepend input-group-append"><span class="input-group-text bg-white border-0">~</span></div>
                                        <input type="number" step="0.01" class="form-control text-center" name="tol_a_bare_max" placeholder="max" value="{{ last_data.tol_a_bare_max if last_data else '' }}">
                                    </div>
                                    <div class="input-group input-group-sm" id="rowBareB">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-b">B</span></div>
                                        <input type="number" step="0.01" class="form-control text-center" name="tol_b_bare_min" placeholder="min" value="{{ last_data.tol_b_bare_min if last_data else '' }}">
                                        <div class="input-group-prepend input-group-append"><span class="input-group-text bg-white border-0">~</span></div>
                                        <input type="number" step="0.01" class="form-control text-center" name="tol_b_bare_max" placeholder="max" value="{{ last_data.tol_b_bare_max if last_data else '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-2">
                            <div class="card h-100 border-secondary">
                                <div class="card-header py-1 text-center bg-light small" id="titleFinished">成品线径 (≤)</div>
                                <div class="card-body px-2 py-2">
                                    <div class="input-group input-group-sm mb-2" id="rowFinishedA">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-a badge-dynamic-a">A</span></div>
                                        <input type="number" step="0.01" class="form-control" name="tol_a_finished_val" placeholder="上限值" value="{{ last_data.tol_a_finished_val if last_data else '' }}">
                                    </div>
                                    <div class="input-group input-group-sm" id="rowFinishedB">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-b">B</span></div>
                                        <input type="number" step="0.01" class="form-control" name="tol_b_finished_val" placeholder="上限值" value="{{ last_data.tol_b_finished_val if last_data else '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-4 mb-2">
                            <div class="card h-100 border-secondary">
                                <div class="card-header py-1 text-center bg-light small" id="titleFilm">漆膜厚度 (≥)</div>
                                <div class="card-body px-2 py-2">
                                    <div class="input-group input-group-sm mb-2" id="rowFilmA">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-a badge-dynamic-a">A</span></div>
                                        <input type="number" step="0.01" class="form-control" name="tol_a_thickness_val" placeholder="下限值" value="{{ last_data.tol_a_thickness_val if last_data else '' }}">
                                    </div>
                                    <div class="input-group input-group-sm" id="rowFilmB">
                                        <div class="input-group-prepend"><span class="input-group-text text-white badge-b">B</span></div>
                                        <input type="number" step="0.01" class="form-control" name="tol_b_thickness_val" placeholder="下限值" value="{{ last_data.tol_b_thickness_val if last_data else '' }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group mt-2 mb-3">
                        <textarea class="form-control border-danger" name="remark" rows="1" placeholder="异常记录 / 备注 (例如：炉温波动...)">{{ last_data.remark if last_data else '' }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-warning btn-block font-weight-bold py-2"><i class="fas fa-save"></i> 保存记录 (存为草稿)</button>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="card-header bg-white py-2 d-flex justify-content-between align-items-center">
                <span class="font-weight-bold small"><i class="fas fa-list"></i>
                    {% if current_user.role == 'admin' %}所有提交记录 & 我的草稿{% else %}我的记录{% endif %}
                </span>
                <a href="/export_all" class="btn btn-outline-success btn-sm py-0" style="font-size: 0.8rem;"><i class="fas fa-file-excel"></i> 导出已提交</a>
            </div>
            <div class="table-responsive">
                <table class="table table-bordered table-hover table-sm text-center mb-0" style="font-size: 0.85rem;">
                    <thead class="thead-light">
                        <tr>
                            <th>时间</th>
                            <th>操作员</th>
                            <th>机台</th>
                            <th>型号</th>
                            <th>规格</th>
                            <th>速度</th>
                            <th>漆工艺</th>
                            <th>备注</th>
                            <th style="min-width: 140px;">状态 / 操作</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in records %}
                        <tr class="{% if not r.is_submitted %}table-warning{% endif %}">
                            <td class="small text-muted">{{ r.create_time.strftime('%m-%d %H:%M') }}</td>
                            <td class="font-weight-bold small">{{ r.operator_name }}</td>
                            <td class="font-weight-bold">{{ r.machine_model }}</td>
                            <td>{{ r.product_type }}</td>
                            <td>{{ r.wire_spec }}</td>
                            <td class="small">{{ r.ref_speed }}</td>
                            <td class="small">{{ r.base_coat_type }}/{{ r.mid_coat_type }}/{{ r.top_coat_type }}</td>
                            <td class="text-left small text-danger text-truncate" style="max-width: 150px;" title="{{ r.remark }}">{{ r.remark }}</td>

                            <td>
                                {% if not r.is_submitted %}
                                    <a href="/submit/{{ r.id }}" class="btn btn-success btn-sm py-0 px-2" onclick="return confirm('确认无误并正式提交吗？提交后不可修改。')">提交</a>
                                    <a href="/delete/{{ r.id }}" class="btn btn-danger btn-sm py-0 px-2 ml-1" onclick="return confirm('确认删除此草稿？')">删除</a>
                                {% else %}
                                    <span class="badge badge-light border text-muted">已入库</span>
                                    {% if current_user.role == 'admin' %}
                                        <a href="/delete/{{ r.id }}" class="text-danger ml-2" onclick="return confirm('管理员操作：确认强制删除此归档记录？')" title="强制删除">&times;</a>
                                    {% endif %}
                                {% endif %}
                            </td>
                        </tr>
                        {% else %}
                        <tr><td colspan="9" class="text-muted py-3">暂无记录</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // JS回填辅助
        var lastBase = "{{ last_data.base_coat_type if last_data else '无' }}";
        var lastMid = "{{ last_data.mid_coat_type if last_data else '无' }}";
        var lastTop = "{{ last_data.top_coat_type if last_data else '无' }}";
        document.getElementById('baseCoatSelect').value = lastBase;
        document.getElementById('midCoatSelect').value = lastMid;
        document.getElementById('topCoatSelect').value = lastTop;

        function updateMachineOptions() {
            const $machineType = $('#machineTypeSelect');
            const $machineNum = $('#machineNumSelect');
            const typeVal = $machineType.val();
            const lastNum = $('#lastMachineNum').val();

            $machineNum.empty();
            $machineNum.append('<option value="" disabled selected>-</option>');

            if (typeVal === '6') {
                ['1A', '1B', '2', '3', '4', '5', '6', '7', '8'].forEach(opt => {
                    $machineNum.append(`<option value="${opt}">${opt}</option>`);
                });
            } else {
                for (let i = 1; i <= 8; i++) {
                    $machineNum.append(`<option value="${i}">${i}</option>`);
                }
            }
            if (lastNum && $machineNum.find(`option[value="${lastNum}"]`).length > 0) {
                $machineNum.val(lastNum);
            }
        }

        function syncSBState() {
            var isChecked = $('#manualSBCheck').prop('checked');
            $('#realSBSwitch').prop('checked', isChecked);
        }

        function handleProductChange() {
            const selectVal = $('#productTypeSelect').val();
            const $input = $('#productTypeInput');
            const $manualGroup = $('#manualControlGroup');
            const $realSB = $('#realSBSwitch');

            if (selectVal === 'OTHER') {
                $input.removeClass('d-none-custom').val('').focus();
                $manualGroup.removeClass('d-none-custom');
                if (!$("input[name='customShape']:checked").val()) {
                     $("#shapeFlat").prop("checked", true);
                }
                $('#manualSBCheck').prop('checked', false);
                syncSBState();
                toggleSpecInput();
            } else if (selectVal) {
                $input.addClass('d-none-custom').val(selectVal);
                $manualGroup.addClass('d-none-custom');

                if (selectVal === 'Q(ZY/XY)-2/220') {
                    showRoundSpec();
                } else {
                    showFlatSpec();
                }

                if (selectVal === 'BYQQNB-2/120') {
                    $realSB.prop('checked', true);
                } else {
                    $realSB.prop('checked', false);
                }
            }
        }

        function toggleSpecInput() {
            const shape = $("input[name='customShape']:checked").val();
            if (shape === 'round') {
                showRoundSpec();
            } else {
                showFlatSpec();
            }
        }

        function showFlatSpec() {
            // 1. 规格输入框
            $('#specFlatGroup').removeClass('d-none-custom');
            $('#specRoundGroup').addClass('d-none-custom');

            // 2. 标准参数 A/B 面复原
            $('#rowBareB, #rowFinishedB, #rowFilmB').removeClass('d-none-custom'); // 显示B面

            // 3. 标签复原为 A / B
            $('.badge-dynamic-a').text('A').removeClass('badge-round').addClass('badge-a');

            // 4. 标题复原
            $('#titleBare').text('半成品裸径');
            $('#titleFinished').text('成品线径 (≤)');
            // 启用 B 面输入框 (防止提交脏数据可选，但后台兼容性好不必须)
            $('#rowBareB input, #rowFinishedB input, #rowFilmB input').prop('disabled', false);
        }

        function showRoundSpec() {
            // 1. 规格输入框
            $('#specRoundGroup').removeClass('d-none-custom');
            $('#specFlatGroup').addClass('d-none-custom');

            // 2. 标准参数：隐藏 B 面
            $('#rowBareB, #rowFinishedB, #rowFilmB').addClass('d-none-custom');

            // 3. 标签变身为 Φ
            $('.badge-dynamic-a').text('Φ').removeClass('badge-a').addClass('badge-round');

            // 4. 标题变身
            $('#titleBare').text('裸线直径');
            $('#titleFinished').text('成品外径 (≤)');

            // 禁用 B 面输入框 (这样提交时不会带任何数据)
            $('#rowBareB input, #rowFinishedB input, #rowFilmB input').prop('disabled', true);
        }

        function initSpecAndSpeedAndSB() {
            const fullSpec = $('#finalWireSpec').val();
            const productVal = $('#productTypeInput').val();
            const fullSpeed = $('#finalSpeedStr').val();
            const isSB = {{ 'true' if last_data and last_data.is_self_bonding == 'on' else 'false' }};

            if (fullSpeed) {
                if (fullSpeed.includes('±')) {
                    const parts = fullSpeed.split('±');
                    $('#speedBase').val(parts[0]);
                    $('#speedTol').val(parts[1]);
                } else {
                    $('#speedBase').val(fullSpeed);
                }
            }

            const $select = $('#productTypeSelect');
            const exists = $select.find(`option[value="${productVal}"]`).length > 0;
            const $realSB = $('#realSBSwitch');
            $realSB.prop('checked', isSB);

            if (exists) {
                $select.val(productVal);
            } else if (productVal) {
                $select.val('OTHER');
                $('#productTypeInput').removeClass('d-none-custom');
                $('#manualControlGroup').removeClass('d-none-custom');
                $('#manualSBCheck').prop('checked', isSB);
            }

            // 初始化判断圆扁
            if (fullSpec.includes('×') || fullSpec.includes('x') || fullSpec.includes('X')) {
                const parts = fullSpec.split(/×|x|X/);
                if (parts.length >= 2) {
                    $('#specA').val(parts[0].trim());
                    $('#specB').val(parts[1].trim());
                }
                showFlatSpec();
                $("#shapeFlat").prop("checked", true);
            } else if (fullSpec) {
                $('#specDiameter').val(fullSpec);
                showRoundSpec();
                $("#shapeRound").prop("checked", true);
            } else {
                handleProductChange();
            }
        }

        function prepareSubmission() {
            const selectVal = $('#productTypeSelect').val();
            if (selectVal !== 'OTHER' && selectVal) {
                $('#productTypeInput').val(selectVal);
            }

            const isRound = !$('#specRoundGroup').hasClass('d-none-custom');
            if (isRound) {
                $('#finalWireSpec').val($('#specDiameter').val());
            } else {
                const a = $('#specA').val();
                const b = $('#specB').val();
                if (a && b) {
                    $('#finalWireSpec').val(`${a}×${b}`);
                }
            }

            const base = $('#speedBase').val();
            const tol = $('#speedTol').val();
            if (base) {
                $('#finalSpeedStr').val(`${base}±${tol}`);
            }

            return true;
        }

        function clearForm() {
            if(!confirm('确定要清空当前所有输入内容吗？')) return;
            $('input[type="text"]').val("");
            $('input[type="number"]').val("");
            $('textarea').val("");
            $('#machineTypeSelect').val("");
            $('#machineNumSelect').empty();
            $('#productTypeSelect').val("");

            $('#speedTol').val("0.5");
            $('#realSBSwitch').prop('checked', false);
            $('#manualSBCheck').prop('checked', false);

            $('#productTypeInput').addClass('d-none-custom');
            $('#manualControlGroup').addClass('d-none-custom');
            showFlatSpec();
        }

        $(document).ready(function() {
            $('#machineTypeSelect').on('change', function() {
                updateMachineOptions();
            });
            updateMachineOptions();
            initSpecAndSpeedAndSB();

            // 漆包类型选“无”自动填0
            $('#baseCoatSelect, #midCoatSelect, #topCoatSelect').on('change', function() {
                if ($(this).val() === '无') {
                    $(this).next('input').val(0);
                }
            });
        });
    </script>
</body>
</html>