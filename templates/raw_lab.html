<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>扁线标准实验室</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
    <style>
        body{background:#e8f5e9;}
        .card{border:none;box-shadow:0 2px 10px rgba(0,0,0,0.05);}
        .badge-a { background-color: #007bff; color: white; }
        .badge-b { background-color: #ff9800; color: white; }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark bg-success mb-3 py-2">
        <div class="container-fluid">
            <div>
                <a class="navbar-brand mb-0 h1 text-white-50" href="/" style="font-size: 1rem;"><i class="fas fa-industry mr-2"></i>生产记录系统</a>
                <a class="navbar-brand mb-0 h1 text-white" href="/raw_lab"><i class="fas fa-flask mr-2"></i>裸线实验室</a>
            </div>
            <div class="text-white small">
                <i class="fas fa-user"></i> {{ current_user.username }}
                <a href="/raw_analysis" class="btn btn-light text-success btn-sm ml-2 font-weight-bold">数据分析 <i class="fas fa-arrow-right"></i></a>
            </div>
        </div>
    </nav>

    <div class="container px-3">
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}{% for cat, msg in messages %}<div class="alert alert-{{ cat }} py-2">{{ msg }}</div>{% endfor %}{% endif %}
        {% endwith %}

        <div class="card mb-3 border-success">
            <div class="card-header bg-white text-success font-weight-bold"><i class="fas fa-plus-circle"></i> 扁线样本采集</div>
            <div class="card-body">
                <form method="POST">
                    <div class="form-row mb-3 pb-2 border-bottom">
                        <div class="col-md-3">
                            <label class="small text-muted">机台</label>
                            <select name="machine_model" class="form-control form-control-sm">
                                <option value="L1">L1 (张力大)</option>
                                <option value="L6">L6 (张力稳)</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="small text-muted">速度 (m/min)</label>
                            <input type="number" step="0.1" name="ref_speed" class="form-control form-control-sm" required>
                        </div>
                        <div class="col-md-3">
                            <label class="small text-dark font-weight-bold">屈服强度 (Mpa)</label>
                            <input type="number" step="1" name="yield_strength" class="form-control form-control-sm border-success" placeholder="如 85" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="col-md-6 border-right">
                            <h6 class="text-primary font-weight-bold"><span class="badge badge-a">A面 (宽边)</span></h6>
                            <div class="form-group row mb-1">
                                <label class="col-4 col-form-label small">投料实测</label>
                                <div class="col-8">
                                    <input type="number" step="0.001" name="raw_size_a" id="ra" class="form-control form-control-sm" required oninput="calc()">
                                </div>
                            </div>
                            <div class="form-group row mb-1">
                                <label class="col-4 col-form-label small">去漆实测</label>
                                <div class="col-8">
                                    <input type="number" step="0.001" name="stripped_size_a" id="sa" class="form-control form-control-sm" required oninput="calc()">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label small text-danger font-weight-bold">吃丝量</label>
                                <div class="col-8">
                                    <input type="text" id="da" class="form-control form-control-sm bg-light text-danger font-weight-bold" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6">
                            <h6 class="text-warning font-weight-bold"><span class="badge badge-b">B面 (厚度)</span></h6>
                            <div class="form-group row mb-1">
                                <label class="col-4 col-form-label small">投料实测</label>
                                <div class="col-8">
                                    <input type="number" step="0.001" name="raw_size_b" id="rb" class="form-control form-control-sm" required oninput="calc()">
                                </div>
                            </div>
                            <div class="form-group row mb-1">
                                <label class="col-4 col-form-label small">去漆实测</label>
                                <div class="col-8">
                                    <input type="number" step="0.001" name="stripped_size_b" id="sb" class="form-control form-control-sm" required oninput="calc()">
                                </div>
                            </div>
                            <div class="form-group row">
                                <label class="col-4 col-form-label small text-danger font-weight-bold">吃丝量</label>
                                <div class="col-8">
                                    <input type="text" id="db" class="form-control form-control-sm bg-light text-danger font-weight-bold" readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-3">
                        <input type="text" name="remark" class="form-control form-control-sm mb-2" placeholder="备注...">
                        <button type="submit" class="btn btn-success btn-block font-weight-bold">保存样本</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="card">
            <div class="table-responsive">
                <table class="table table-sm table-hover text-center mb-0" style="font-size: 0.85rem;">
                    <thead class="thead-light">
                        <tr>
                            <th rowspan="2" style="vertical-align:middle;">机台/速度</th>
                            <th rowspan="2" style="vertical-align:middle;">强度</th>
                            <th colspan="2" class="text-primary">A面 (宽)</th>
                            <th colspan="2" class="text-warning">B面 (厚)</th>
                            <th rowspan="2" style="vertical-align:middle;">操作</th>
                        </tr>
                        <tr>
                            <th>投 / 去</th>
                            <th>吃丝</th>
                            <th>投 / 去</th>
                            <th>吃丝</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for r in records %}
                        <tr>
                            <td>{{ r.machine_model }}<br><span class="text-muted">{{ r.ref_speed }}</span></td>
                            <td class="font-weight-bold">{{ r.yield_strength }}</td>

                            <td>{{ r.raw_size_a }}<br>{{ r.stripped_size_a }}</td>
                            <td class="text-danger font-weight-bold align-middle">{{ "%.3f"|format(r.draw_down_a) }}</td>

                            <td>{{ r.raw_size_b }}<br>{{ r.stripped_size_b }}</td>
                            <td class="text-danger font-weight-bold align-middle">{{ "%.3f"|format(r.draw_down_b) }}</td>

                            <td class="align-middle"><a href="/delete_raw/{{ r.id }}" class="text-danger">&times;</a></td>
                        </tr>
                        {% else %}
                        <tr><td colspan="7" class="text-muted py-3">暂无扁线数据</td></tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        function calc(){
            let ra = parseFloat(document.getElementById('ra').value);
            let sa = parseFloat(document.getElementById('sa').value);
            if(ra&&sa) document.getElementById('da').value = (ra-sa).toFixed(3);

            let rb = parseFloat(document.getElementById('rb').value);
            let sb = parseFloat(document.getElementById('sb').value);
            if(rb&&sb) document.getElementById('db').value = (rb-sb).toFixed(3);
        }
    </script>
</body>
</html>